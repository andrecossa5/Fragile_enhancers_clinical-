---
title: "Number_of_mutations"
output: html_document
date: "2024-02-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
library(ggpubr) # to add p-values to plots

SEED <- 4321
set.seed(SEED)

source("/Users/ieo6983/Desktop/fragile_enhancer_clinical/utils/functions_genomics.R")

IN_FOLDER <- "/Users/ieo6983/Desktop/fragile_enhancer_clinical/"
OUT_FOLDER_DATA <- "/Users/ieo6983/Desktop/fragile_enhancer_clinical/results/ICGC/enhancers_SSMs_overlaps/data/"
OUT_FOLDER_PLOTS <- "/Users/ieo6983/Desktop/fragile_enhancer_clinical/results/ICGC/enhancers_SSMs_overlaps/plots/"
```


```{r}
# Functions 

compute_stat_enhancers2 <- function(input_overlaps, source_enhancers_df){
  
  df_all_stats <- data.frame(matrix(ncol = length(input_overlaps)+1, # +1 to store enh names 
                                    nrow = dim(source_enhancers_df[[1]])[1]))
  colnames(df_all_stats) <- c("name", "n_donors_hit")
  
  for(i in 1:length(input_overlaps)){
    df_overlaps <- input_overlaps[[i]]
    df_source <- source_enhancers_df[[i]]
    
    # Compute number of donors in which each enhancer is mutated
    stat_enh <- df_overlaps %>% dplyr::group_by(name) %>%
      dplyr::summarise(., n_donors_hit = length(unique(icgc_donor_id)))
    
    # Add to df enhancers with no mutation in any patient
    stat_enh <- rbind(stat_enh, 
                      data.frame("name" = df_source$name[!df_source$name %in% stat_enh$name], 
                                 "n_donors_hit" = rep(0, length(df_source$name[!df_source$name %in% stat_enh$name]))))
    
    # add to df_all_stats
    df_all_stats[, i] <- stat_enh$name
    df_all_stats[, i+1] <- stat_enh$n_donors_hit
  }
  
  return(df_all_stats)
}


```


### INPUT DATA ###
```{r}
# SSMs
SSMs <- read_tsv(paste(IN_FOLDER, "./data/genomics/pre_processed_ICGC/simple_somatic_mutation.open.matching_calls.tsv", sep=""))
SSMs <- SSMs[, -c(9,14)]
colnames(SSMs)[c(7,8)] <- c("start", "end") 
SSMs$chromosome <- paste("chr", SSMs$chromosome, sep = "")
SSMs_gr <- makeGRangesFromDataFrame(SSMs, keep.extra.columns = T)


# ALL enhancers: CtIP, GRHL
columns_names <- c("chrom", "start", "end", "cluster")
enh_ctip <- read_tsv(paste(IN_FOLDER, "data/functional_genomics/others/Cluster_CtIP_Enh_All.txt", sep=""), col_names = columns_names,
                     comment = "#")
enh_grhl <- read_tsv(paste(IN_FOLDER, "data/functional_genomics/others/Cluster_GRHL_Enh_All.txt", sep=""), col_names = columns_names,
                     comment = "#")
enh_all <- list("CtIP" = enh_ctip, "GRHL" = enh_grhl)
# add summit & name
enh_all <- lapply(enh_all, function(df){
  df$summit <- df$end
  df$name <- str_c(df$chrom, df$summit, sep=":")
  return(df)})


# Putative enhancers: H3K27ac (no CtIP, GRHL, MRE11, self_overlaps)
put_enhancers <- read_tsv(paste(IN_FOLDER, "data/functional_genomics/others/PutativeEnhnacers_MCF10A_hg19.filtered_GRHL_CtIP_MRE11_self.tsv", sep=""))
colnames(put_enhancers)[1] <- "chrom" 
put_enhancers$summit <- put_enhancers$end


### 
WIN <- 500
MARKERS <- names(enh_all)

```



# Number of mutations within each enhancer
```{r}
input_variants <- SSMs
input_variants_gr <- SSMs_gr


for(marker in MARKERS){
  mut <- "SSMs"
  
  
  ### Pre/process input data ###
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'
  
  ## Extend regions of 'win' from summit
  marker_enh$start <- marker_enh$summit - WIN
  marker_enh$end <- marker_enh$summit + WIN
  
  # Create GRanges objects 
  enh_gr <- makeGRangesFromDataFrame(marker_enh, keep.extra.columns = T)
  
  
  ### Find mutations / enhancers overlaps ###
  # CtIP/GRHL enhancers - overlap with matching SSMs 
  hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
  SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
  colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_") 
  enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj)
  
  
  ### Compute stats
  # Number of donors that each enhancer hit
  classes = "n_donors_hit"
  stat_enh <- compute_stat_enhancers2(list(enh_SSMs), list(marker_enh)) 
  
  # Number of mutations within each enahncer
  #enh_SSMs$mut_coord_id <- str_c(enh_SSMs$seqnames_sbj, enh_SSMs$start_sbj, enh_SSMs$end_sbj, sep = "_")
  
  n_muts_enh <- enh_SSMs %>% group_by(name) %>% 
  dplyr::summarise(n_muts = n()) %>%
  ungroup() %>%
  dplyr::select(name, n_muts) 
  n_muts_enh <- arrange(n_muts_enh, desc(n_muts_enh$n_muts))
  
  p <- n_muts_enh %>%
  ggplot(., aes(x = n_muts))+
  geom_histogram()+
    theme_light()+
    labs(title = paste("Number of mutations within each ", marker, " enhancer", sep =""), 
         x = "Number of mutations", y = "")
  print(p)
 
  
  # Dotplot - add fileds with 0
  for_dot <- left_join(stat_enh, n_muts_enh, by = "name")
  for_dot$n_muts[is.na(for_dot$n_muts)] <- 0
  
  scatter <- for_dot %>% 
      ggplot(., aes(x = n_donors_hit, y = n_muts))+
        geom_count(aes(size = ..n..), color = "blue3")+
        scale_size_continuous(range = c(2, 10))+
        theme_light()+
        labs(title = paste(marker, " enhancers - Win = ", WIN, " bp", sep = ""),
          y = "Number of mutations within enhancer", 
          x = "Number of donors")+
        theme(axis.text = element_text(size = 12),
              axis.title = element_text(size = 16),
              title = element_text(size = 16))+
        scale_y_continuous(n.breaks = 7)+
        scale_x_continuous(n.breaks = 8)
    print(scatter)
  
  # Saving number of mutations x enhancer for the future
  #write_tsv(n_muts_enh, paste(OUT_FOLDER_DATA, paste("Number_of_mutations_x_enhancer", marker, mut, sep="_"), sep =""))
  
  #ggsave(paste(paste(OUT_FOLDER_PLOTS, paste("Number_mutations_vs_number_donors", marker, mut, sep ="_"), sep = ""), ".png", sep = ""), plot = scatter, device = "png", width = 10, height = 7)

}

```




### Number of mutations x enhancers ###
Boxplots with controls (CtIP-high, CtIP-low, random seqs)

_Definition of High-low clusters_
# Option 1: High = primi 3; Low = ultimi 4
clust_high_ctip <- c("CtIP_cluster_2_Enh", "CtIP_cluster_3_Enh", "CtIP_cluster_5_Enh")
clust_high_grhl <- c("GRHL_cluster_1_Enh", "GRHL_cluster_2_Enh", "GRHL_cluster_4_Enh")
clust_low_ctip <- c("CtIP_cluster_6.2_Enh", "CtIP_cluster_6.3_Enh", "CtIP_cluster_6.1_Enh", "CtIP_cluster_6.0")
clust_low_grhl <- c("GRHL_cluster_5.2_Enh", "GRHL_cluster_5.3_Enh", "GRHL_cluster_5.1_Enh", "GRHL_cluster_5.0")
# Option 2: High = primi 4; Low = ultimi 3
clust_high_ctip <- c("CtIP_cluster_2_Enh", "CtIP_cluster_3_Enh", "CtIP_cluster_5_Enh", "CtIP_cluster_6.2_Enh")
clust_high_grhl <- c("GRHL_cluster_1_Enh", "GRHL_cluster_2_Enh", "GRHL_cluster_4_Enh", "GRHL_cluster_5.2_Enh")
clust_low_ctip <- c("CtIP_cluster_6.3_Enh", "CtIP_cluster_6.1_Enh", "CtIP_cluster_6.0")
clust_low_grhl <- c("GRHL_cluster_5.3_Enh", "GRHL_cluster_5.1_Enh", "GRHL_cluster_5.0")
# Option 3: High = primi 5; Low = utlimi 2
clust_high_ctip <- c("CtIP_cluster_2_Enh", "CtIP_cluster_3_Enh", "CtIP_cluster_5_Enh", "CtIP_cluster_6.2_Enh", "CtIP_cluster_6.3_Enh")
clust_high_grhl <- c("GRHL_cluster_1_Enh", "GRHL_cluster_2_Enh", "GRHL_cluster_4_Enh", "GRHL_cluster_5.2_Enh", "GRHL_cluster_5.2_Enh")
clust_low_ctip <- c("CtIP_cluster_6.1_Enh", "CtIP_cluster_6.0")
clust_low_grhl <- c("GRHL_cluster_5.1_Enh", "GRHL_cluster_5.0")
```{r}
# Definition of which are high and which low clusters
# Option 1: High = primi 3; Low = ultimi 4
clust_high_ctip <- c("CtIP_cluster_2_Enh", "CtIP_cluster_3_Enh", "CtIP_cluster_5_Enh")
clust_high_grhl <- c("GRHL_cluster_1_Enh", "GRHL_cluster_2_Enh", "GRHL_cluster_4_Enh")
clust_low_ctip <- c("CtIP_cluster_6.2_Enh", "CtIP_cluster_6.3_Enh", "CtIP_cluster_6.1_Enh", "CtIP_cluster_6.0")
clust_low_grhl <- c("GRHL_cluster_5.2_Enh", "GRHL_cluster_5.3_Enh", "GRHL_cluster_5.1_Enh", "GRHL_cluster_5.0")

clust_high <- list("CtIP" = clust_high_ctip, "GRHL" = clust_high_grhl)
clust_low <- list("CtIP" = clust_low_ctip, "GRHL" = clust_low_grhl)
clust_all <- list("high" = clust_high, "low" = clust_low)

```


```{r}
input_variants <- SSMs
input_variants_gr <- SSMs_gr


save_plots <- FALSE

sample_enhancers <- FALSE # If TRUE, sample 'n_enhancers_to_sample' from each cluster (high vs. low)
n_enhancers_to_sample <- 1500

plot_p_values_random <- FALSE # If TRUE, sample random regions multiple times, compute p-values for each draw and plot distribution
n_samples <- 1000
start_seed <- 4321
pval_dist_ctrl_random <- list("CtIP" = list("high" = c(), "low" = c()), "GRHL" = list("high" = c(), "low" = c()))

plot_p_values_cases <- FALSE
sample_size <- 1900 # number of enhancers to sample with replacement

max_dim <- max(sapply(enh_all, function(df) dim(df)[1]))
number_mutations_x_enhancer <- list("CtIP" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)), 
                                    "GRHL" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)))

for(marker in MARKERS){
  mut <- "SSMs"
  
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'

  for(cluster in c("high", "low")){
    marker_enh_clust <- marker_enh[marker_enh$cluster %in% clust_all[[cluster]][[marker]], ]
    # RANDOM SAMPLING OF ENHANCERS
    if(sample_enhancers ==T){
      marker_enh_clust <- marker_enh_clust[sample(x = 1:dim(marker_enh_clust)[1], 
                                                  size = n_enhancers_to_sample, replace = F),]
    }
    
    ## Extend regions of 'win' from summit
    marker_enh_clust$start <- marker_enh_clust$summit - WIN
    marker_enh_clust$end <- marker_enh_clust$summit + WIN
    
    # Generate random input sequences 
    ran_seqs <- generate_random_seqs(SEED, dim(marker_enh_clust)[1], win = WIN)
    # Create GRanges objects 
    enh_gr <- makeGRangesFromDataFrame(marker_enh_clust, keep.extra.columns = T)
    ran_seqs_gr = makeGRangesFromDataFrame(ran_seqs, keep.extra.columns = T)
    
    
    ### Find mutations / enhancers overlaps ###
    # CtIP/GRHL enhancers - overlap with matching SSMs 
    hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj) 
    # Random sequences
    hits_obj_ran <- findOverlaps(query=ran_seqs_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_ran)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    ran_seqs_SSMs <- cbind(data.frame(ran_seqs_gr[queryHits(hits_obj_ran)], SSMs_sbj))
  
    # Total number of mutations x group (high-low)
    print(sprintf("Total number of mutations x group - WIN: %d - Marker: %s", WIN, marker))
    print(paste(cluster, dim(enh_SSMs)[1]))
    
    # Number of mutations within each enhancer
    n_muts_enh <- enh_SSMs %>% group_by(name) %>% 
      dplyr::summarise(n_muts = n()) %>%
      ungroup() %>%
      dplyr::select(name, n_muts)
    
    # Add enhancers with 0 mutations
    enh_0_muts <- unique(marker_enh_clust$name[!marker_enh_clust$name %in% n_muts_enh$name])
    n_muts_enh <- rbind(n_muts_enh, data.frame("name" = enh_0_muts, "n_muts" = 0))
    n_muts_enh <- arrange(n_muts_enh, desc(n_muts_enh$n_muts))
    
    n_muts_ran <- ran_seqs_SSMs %>% group_by(name) %>% 
      dplyr::summarise(n_muts = n()) %>%
      ungroup() %>%
      dplyr::select(name, n_muts) 
    
    # Add enhancers with 0 mutations
    ran_0_muts <- unique(ran_seqs$name[!ran_seqs$name %in% n_muts_ran$name])
    n_muts_ran <- rbind(n_muts_ran, data.frame("name" = ran_0_muts, "n_muts" = 0))
    n_muts_ran <- arrange(n_muts_ran, desc(n_muts_ran$n_muts))

    
    number_mutations_x_enhancer[[marker]][, cluster] <- c(n_muts_enh$n_muts, rep(NA, max_dim-length(n_muts_enh$n_muts)))
    number_mutations_x_enhancer[[marker]][, paste(cluster, "ctrl", sep="_")] <- c(n_muts_ran$n_muts, 
                                                                                  rep(NA, max_dim-length(n_muts_ran$n_muts)))
    
    if(plot_p_values_random == T){
      pval_dist_ctrl_random[[marker]][[cluster]] <- compute_pval_dist_ctrl_random(n_samples = n_samples, start_seed = start_seed,
                            cluster_enh = marker_enh_clust, input_variants_gr = input_variants_gr, n_mutations_case = n_muts_enh)
      
    }
    
  }
}




## Plot mutation frequency x enhancer + CTRLs ##
for(marker in MARKERS){
  df <- number_mutations_x_enhancer[[marker]] 
  df_pivot <- df %>% pivot_longer(everything(), names_to="cluster", values_to="n_muts") %>%
  mutate(., group = ifelse(startsWith(cluster,"high"), "high", "low"))
  
  print("Average")
  m_high <- round(mean(df$high, na.rm =T),3)
  m_high_ctrl <- round(mean(df$high_ctrl, na.rm=T),3)
  m_low <- round(mean(df$low, na.rm=T),3)
  m_low_ctrl <- round(mean(df$low_ctrl, na.rm =T),3)
  print(m_high); print(m_high_ctrl); print(m_low); print(m_low_ctrl)
  
  p <- df_pivot %>% ggplot(., aes(x = cluster, y = n_muts, fill = group))+
    geom_boxplot()+
    theme_light()+
    labs(title = paste("Number of mutations x enhancer - ", marker, sep=""),
        y = "Number of mutations", x = "")+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p)
  
  p2 <- df_pivot %>% ggplot(., aes(x = cluster, y = n_muts, fill = group))+
    geom_violin()+
    theme_light()+
    labs(title = paste("Number of mutations x enhancer - ", marker, sep=""),
        y = "Number of mutations", x = "")+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p2)
  
  if(save_plots == T){
  ggsave(plot = p, filename = paste(OUT_FOLDER_PLOTS, paste("Number_", mut, "_x_enhancer.", marker, "_high_low_and_controls.png", sep=""), sep=""), device = "png", width = 10, height = 7)
  }
  
}


### PLOT P-VALUES
## High vs. ctrl / Low vs. ctrl
if(plot_p_values_random == T){
for(marker in MARKERS){
  df_high <- data.frame("x" = pval_dist_ctrl_random[[marker]]$high)
  df_low <- data.frame("x" = pval_dist_ctrl_random[[marker]]$low)  
  # Ratio of p-values <= 0.05 over total number of p-values
  sig_ratio_high <- sum(df_high$x <= 0.05) / length(df_high$x)
  sig_ratio_low <- sum(df_low$x <= 0.05) / length(df_low$x)
  
  hh <- df_high %>%
    ggplot(., aes(x))+
    geom_histogram(binwidth = 0.001)+
    labs(title = sprintf("Ratio of significant p-values: %.2f", round(sig_ratio_high,2)))
  print(hh)
  
  hl <- df_low %>%
    ggplot(., aes(x))+
    geom_histogram(binwidth = 0.001)+
    labs(title = sprintf("Ratio of significant p-values: %.2f", round(sig_ratio_low,2)))
  print(hl)
}
df <- data.frame("CtIP-high" = pval_dist_ctrl_random$CtIP$high, 
           "CtIP-low" = pval_dist_ctrl_random$CtIP$low, 
           "GRHL-high" = pval_dist_ctrl_random$GRHL$high, 
           "GRHL-low" = pval_dist_ctrl_random$GRHL$low)
#write_tsv(df, file = paste(OUT_FOLDER_DATA, "P_values.N_muts_x_enh.Cases_vs_random.n_sample_1000.tsv"))
}
   

# For each group of enhancers (i.e. CtIP-High), X enhancers are samples WITH replacement
# Enhancers are overlapped with  
# P-values are computed using wilcoxon test
if(plot_p_values_cases == T){
  pval_dist_cases <- compute_pval_dist_cases(n_samples = n_samples, start_seed = start_seed, 
                                             sample_size = sample_size, df_vars = number_mutations_x_enhancer)
}
## High vs. Low
for(marker in MARKERS){
  r_m <- round(sum(pval_dist_cases[[marker]] <= 0.05) / length(pval_dist_cases[[marker]]),2)

  p <- data.frame(x = pval_dist_cases[[marker]]) %>%
    ggplot(., aes(x))+
    geom_histogram()+
    geom_vline(xintercept = 0.05, color = "red")+
    labs(title = sprintf("Ratio of significant p-values: %.2f", r_m))
  print(p)
}

```


## Multiple sampling of random genomic regions ###
```{r}
start_time <- Sys.time()

n_samples <- 100
start_seed <- 4321
number_of_mutations_x_random <- list("CtIP" = data.frame("avg_high" = rep(NA, n_samples), "avg_low" = rep(NA, n_samples)), 
                                     "GRHL" = data.frame("avg_high" = rep(NA, n_samples), "avg_low" = rep(NA, n_samples)))


random_sampling <- FALSE
if(random_sampling == T){
    for(marker in MARKERS){
      
      # select appropriate cluster of enhancers to sample the same number of random regions
      marker_enh <- enh_all[[marker]] 
      
      for(cluster in c("high", "low")){
        marker_enh_clust <- marker_enh[marker_enh$cluster %in% clust_all[[cluster]][[marker]], ]
        
        random_regions_avgs <- data.frame(matrix(ncol = 1, nrow = n_samples, dimnames = list(NULL, "avg_n_muts")))
        for(i in 1:n_samples){
          # Generate random input sequences 
          ran_seqs <- generate_random_seqs(start_seed+i, dim(marker_enh_clust)[1], win = WIN)
          ran_seqs_gr = makeGRangesFromDataFrame(ran_seqs, keep.extra.columns = T)
                
          hits_obj_ran <- findOverlaps(query=ran_seqs_gr, subject=input_variants_gr)
          SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_ran)])
          colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
          ran_seqs_SSMs <- cbind(data.frame(ran_seqs_gr[queryHits(hits_obj_ran)], SSMs_sbj))
                
          ran_seqs_SSMs$mut_coord_id <- str_c(ran_seqs_SSMs$seqnames_sbj, ran_seqs_SSMs$start_sbj, ran_seqs_SSMs$end_sbj, sep = "_")
          
          n_muts_ran <- ran_seqs_SSMs %>% group_by(name) %>% 
            dplyr::summarise(n_muts = length(unique(mut_coord_id))) %>%
            ungroup() %>%
            dplyr::select(name, n_muts) 
                
          # Average number of mutations within random genomic regions, for each random sample
          random_regions_avgs[i,] <- round(mean(n_muts_ran$n_muts, na.rm=T),3)
          }
              
        # Store everything in one df for later
        number_of_mutations_x_random[[marker]][, paste("avg", cluster, sep="_")] <- random_regions_avgs$avg_n_muts
    
      }
      
    }
  
}

end_time <- Sys.time()
print(end_time - start_time)

```



### Number of donors mutated x enhancers ###
Boxplots with controls (CtIP-high, CtIP-low, random seqs)
```{r}
input_variants <- SSMs
input_variants_gr <- SSMs_gr

save_plots <- FALSE
max_dim <- max(sapply(enh_all, function(df) dim(df)[1]))
number_donors_x_enhancer <- list("CtIP" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                      "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)), 
                                 "GRHL" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                      "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)))

for(marker in MARKERS){
  mut <- "SSMs"
  
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'

  for(cluster in c("high", "low")){
    marker_enh_clust <- marker_enh[marker_enh$cluster %in% clust_all[[cluster]][[marker]], ]
    if(sample_enhancers == T){
      marker_enh_clust <- marker_enh_clust[sample(x = 1:dim(marker_enh_clust)[1], 
                                           size = n_enhancers_to_sample, replace = F),]
    }
    
    ## Extend regions of 'win' from summit
    marker_enh_clust$start <- marker_enh_clust$summit - WIN
    marker_enh_clust$end <- marker_enh_clust$summit + WIN
    
    # Generate random input sequences 
    ran_seqs <- generate_random_seqs(SEED, dim(marker_enh_clust)[1], win = WIN)
    # Create GRanges objects 
    enh_gr <- makeGRangesFromDataFrame(marker_enh_clust, keep.extra.columns = T)
    ran_seqs_gr = makeGRangesFromDataFrame(ran_seqs, keep.extra.columns = T)
    
    
    ### Find mutations / enhancers overlaps ###
    # CtIP/GRHL enhancers - overlap with matching SSMs 
    hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj) 
    # Random sequences
    hits_obj_ran <- findOverlaps(query=ran_seqs_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_ran)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    ran_seqs_SSMs <- cbind(data.frame(ran_seqs_gr[queryHits(hits_obj_ran)], SSMs_sbj))
  
    # Total number of donors mutated x group (high-low)
    print(sprintf("Total number of donors mutated x group - WIN: %d - Marker: %s", WIN, marker))
    print(paste(cluster, length(unique(enh_SSMs$icgc_donor_id))))
    
    # Number of donors mutated x enhancer
    n_don_enh <- enh_SSMs %>% dplyr::group_by(name) %>%
      dplyr::summarise(., n_donors_hit = length(unique(icgc_donor_id)))
    n_don_ran <- ran_seqs_SSMs %>% dplyr::group_by(name) %>%
      dplyr::summarise(., n_donors_hit = length(unique(icgc_donor_id)))
    
    # Add enhancers mutated in 0 donors 
    enh_0_don <- unique(marker_enh_clust$name[!marker_enh_clust$name %in% n_don_enh$name])
    n_don_enh <- rbind(n_don_enh, data.frame("name" = enh_0_don, "n_donors_hit" = 0))
    ran_0_don <- unique(ran_seqs$name[!ran_seqs$name %in% n_don_ran$name])
    n_don_ran <- rbind(n_don_ran, data.frame("name" = ran_0_don, "n_donors_hit" = 0))
            
    number_donors_x_enhancer[[marker]][, cluster] <- c(n_don_enh$n_donors_hit, rep(NA, max_dim-length(n_don_enh$n_donors_hit)))
    number_donors_x_enhancer[[marker]][, paste(cluster, "ctrl", sep="_")] <- c(n_don_ran$n_donors_hit, 
                                                                            rep(NA, max_dim-length(n_don_ran$n_donors_hit)))
    
  }
}



## Plot number of donors hit x enhancer + CTRLs ##
for(marker in MARKERS){
  df <- number_donors_x_enhancer[[marker]] 
  df_pivot <- df %>% pivot_longer(everything(), names_to="cluster", values_to="n") %>%
  mutate(., group = ifelse(startsWith(cluster,"high"), "high", "low"))
  
  print("Average")
  m_high <- round(mean(df$high, na.rm =T),3)
  m_high_ctrl <- round(mean(df$high_ctrl, na.rm=T),3)
  m_low <- round(mean(df$low, na.rm=T),3)
  m_low_ctrl <- round(mean(df$low_ctrl, na.rm =T),3)
  print(m_high); print(m_high_ctrl); print(m_low); print(m_low_ctrl)
  
  p <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_boxplot()+
    theme_light()+
    labs(title = paste("Number of donors mutates x enhancer - ", marker, sep=""),
        y = "Number of donors", x = "")+
    scale_fill_manual(values = c("darkviolet", "darkolivegreen3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p)
  
  p2 <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_violin()+
    theme_light()+
    labs(title = paste("Number of donors mutates x enhancer - ", marker, sep=""),
        y = "Number of donors", x = "")+
    scale_fill_manual(values = c("darkviolet", "darkolivegreen3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p2)
  
  if(save_plots == T){
  ggsave(plot = p, filename = paste(OUT_FOLDER_PLOTS, paste("Number_donors_x_enhancer.", mut, "_", marker, "_high_low_and_controls.png", sep=""), sep=""), device = "png", width = 10, height = 7)
  }
}


## High vs. Low
if(plot_p_values_cases == T){
  pval_dist_cases <- compute_pval_dist_cases(n_samples = n_samples, start_seed = start_seed, 
                                             sample_size = sample_size, df_vars = number_donors_x_enhancer)
}

for(marker in MARKERS){
  r_m <- round(sum(pval_dist_cases[[marker]] <= 0.05) / length(pval_dist_cases[[marker]]),2)

  p <- data.frame(x = pval_dist_cases[[marker]]) %>%
    ggplot(., aes(x))+
    geom_histogram()+
    geom_vline(xintercept = 0.05, color = "red")+
    labs(title = sprintf("Ratio of significant p-values: %.2f", r_m))
  print(p)
}

```




### Number of enhancers mutated x donor ###
Boxplots with controls (CtIP-high, CtIP-low, random seqs)
```{r}
input_variants <- SSMs
input_variants_gr <- SSMs_gr

save_plots <- FALSE
max_dim <- length(unique(SSMs$icgc_donor_id))
number_enhancers_x_donor <- list("CtIP" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                     "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)), 
                                  "GRHL" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                      "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)))

for(marker in MARKERS){
  mut <- "SSMs"
  
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'

  for(cluster in c("high", "low")){
    marker_enh_clust <- marker_enh[marker_enh$cluster %in% clust_all[[cluster]][[marker]], ]
    if(sample_enhancers == T){
      marker_enh_clust <- marker_enh_clust[sample(x = 1:dim(marker_enh_clust)[1], 
                                           size = n_enhancers_to_sample, replace = F),]
    }
    
    ## Extend regions of 'win' from summit
    marker_enh_clust$start <- marker_enh_clust$summit - WIN
    marker_enh_clust$end <- marker_enh_clust$summit + WIN
    
    # Generate random input sequences 
    ran_seqs <- generate_random_seqs(SEED, dim(marker_enh_clust)[1], win = WIN)
    # Create GRanges objects 
    enh_gr <- makeGRangesFromDataFrame(marker_enh_clust, keep.extra.columns = T)
    ran_seqs_gr = makeGRangesFromDataFrame(ran_seqs, keep.extra.columns = T)
    
    
    ### Find mutations / enhancers overlaps ###
    # CtIP/GRHL enhancers - overlap with matching SSMs 
    hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj) 
    # Random sequences
    hits_obj_ran <- findOverlaps(query=ran_seqs_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_ran)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    ran_seqs_SSMs <- cbind(data.frame(ran_seqs_gr[queryHits(hits_obj_ran)], SSMs_sbj))
    
    # Total number of enhancers mutated x group (high-low)
    print(sprintf("Total number of enhancers mutated x group - WIN: %d - Marker: %s", WIN, marker))
    print(paste(cluster, length(unique(enh_SSMs$name))))
  

    # Number of enhancers mutated x enhancer
    n_enh_mut <- enh_SSMs %>% dplyr::group_by(icgc_donor_id) %>%
      dplyr::summarise(., n_enh_hit = length(unique(name)))
    n_ran_mut <- ran_seqs_SSMs %>% dplyr::group_by(icgc_donor_id) %>%
      dplyr::summarise(., n_ran_hit = length(unique(name)))
    
    # Add donors with 0 enhancers mutated
    don_0_enh <- unique(SSMs$icgc_donor_id[!SSMs$icgc_donor_id %in% n_enh_mut$icgc_donor_id])
    n_enh_mut <- rbind(n_enh_mut, data.frame("icgc_donor_id" = don_0_enh, "n_enh_hit" = 0))
    don_0_ran <- unique(SSMs$icgc_donor_id[!SSMs$icgc_donor_id %in% n_ran_mut$icgc_donor_id])
    n_ran_mut <- rbind(n_ran_mut, data.frame("icgc_donor_id" = don_0_ran, "n_ran_hit" = 0))
    
    
    number_enhancers_x_donor[[marker]][, cluster] <- c(n_enh_mut$n_enh_hit, rep(NA, max_dim-length(n_enh_mut$n_enh_hit)))
    number_enhancers_x_donor[[marker]][, paste(cluster, "ctrl", sep="_")] <- c(n_ran_mut$n_ran_hit, 
                                                                            rep(NA, max_dim-length(n_ran_mut$n_ran_hit)))
    
  }
}


perc <- FALSE
## Plot number of enhancers mutated x donor + CTRLs ##
for(marker in MARKERS){
  df <- number_enhancers_x_donor[[marker]] 
  
  sample_size_clust <- list("high" = NA, "low" = NA)
  for(cluster in c("high", "low")){
    enh_marker <- enh_all[[marker]]
    sample_size_clust[[cluster]] <- dim(na.omit(enh_marker[enh_marker$cluster %in% clust_all[[cluster]][[marker]], ]))[1]
  }
  
  y_axis_label <- "Number of enhancers"
  if(perc == T){
    df[, 1] <- df[, 1] / sample_size_clust[["high"]] * 100
    df[, 2] <- df[, 2] / sample_size_clust[["high"]] * 100
    df[, 3] <- df[, 3] / sample_size_clust[["low"]] * 100
    df[, 4] <- df[, 4] / sample_size_clust[["low"]] * 100
    
    y_axis_label <- "Percentage of enhancers"
  }
  
  df_pivot <- df %>% pivot_longer(everything(), names_to="cluster", values_to="n") %>%
  mutate(., group = ifelse(startsWith(cluster,"high"), "high", "low"))
  
  print("Average")
  m_high <- round(mean(df$high, na.rm =T),3)
  m_high_ctrl <- round(mean(df$high_ctrl, na.rm=T),3)
  m_low <- round(mean(df$low, na.rm=T),3)
  m_low_ctrl <- round(mean(df$low_ctrl, na.rm =T),3)
  print(m_high); print(m_high_ctrl); print(m_low); print(m_low_ctrl)
  
  scale_log <- TRUE
  p <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_boxplot()+
    theme_light()+
    labs(title = paste("Enhancers mutated x donor - ", marker, sep=""),
        y = y_axis_label, x = "")+
    scale_fill_manual(values = c("brown3", "deepskyblue3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  if(scale_log == TRUE){p <- p + scale_y_log10()+labs(y = "log10(Number of enhancers)")}
  print(p)
  
  p2 <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_violin()+
    theme_light()+
    labs(title = paste("Percentage of enhancers mutated x donor - ", marker, sep=""),
        y = y_axis_label, x = "")+
    scale_fill_manual(values = c("brown3", "deepskyblue3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  if(scale_log == TRUE & perc == T){p <- p + scale_y_log10()+labs(y = "log10(Number of enhancers)")}
  print(p2)
  
  if(save_plots == T){
  ggsave(plot = p, filename = paste(OUT_FOLDER_PLOTS, paste("Number_enhancers_x_donor.", mut, "_", marker, "_high_low_and_controls.png", sep=""), sep=""), device = "png", width = 10, height = 7)
  }

}

## High vs. Low
if(plot_p_values_cases == T){
  pval_dist_cases <- compute_pval_dist_cases(n_samples = n_samples, start_seed = start_seed, 
                                             sample_size = sample_size, df_vars = number_enhancers_x_donor)
}

for(marker in MARKERS){
  r_m <- round(sum(pval_dist_cases[[marker]] <= 0.05) / length(pval_dist_cases[[marker]]),2)

  p <- data.frame(x = pval_dist_cases[[marker]]) %>%
    ggplot(., aes(x))+
    geom_histogram()+
    geom_vline(xintercept = 0.05, color = "red")+
    labs(title = sprintf("Ratio of significant p-values: %.2f", r_m))
  print(p)
}
```



#### STSMs ####

```{r}
### INPUT FILES
# STSMs - No start-end, but chrom_bkpt
STSMs <- read_tsv(paste(IN_FOLDER, "data/genomics/pre_processed_ICGC/structural_somatic_mutation.preprocessed.tsv", sep=""))
STSMs <- STSMs[, -c(10, 12, 15, 17)]
STSMs$chrom <- paste("chr", STSMs$chrom, sep = "")
STSMs$start <- STSMs$chrom_bkpt
STSMs$end <- STSMs$chrom_bkpt

STSMs_gr <- makeGRangesFromDataFrame(STSMs, keep.extra.columns = T)

WIN <- 3000
```


# Number of mutations within each enhancer
```{r}
input_variants <- STSMs
input_variants_gr <- STSMs_gr



for(marker in MARKERS){
  mut <- "STSMs"
  
  ### Pre/process input data ###
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'
  
  ## Extend regions of 'win' from summit
  marker_enh$start <- marker_enh$summit - WIN
  marker_enh$end <- marker_enh$summit + WIN
  
  # Create GRanges objects 
  enh_gr <- makeGRangesFromDataFrame(marker_enh, keep.extra.columns = T)
  
  ### Find mutations / enhancers overlaps ###
  # CtIP/GRHL enhancers - overlap with matching SSMs 
  hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
  SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
  colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
  enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj)
  
  
  ### Compute stats
  # Number of donors that each enhancer hit
  classes = "n_donors_hit"
  stat_enh <- compute_stat_enhancers2(list(enh_SSMs), 
                             list(marker_enh))
  
  # Number of mutations within each enahncer
  enh_SSMs$mut_coord_id <- str_c(enh_SSMs$seqnames_sbj, enh_SSMs$start_sbj, enh_SSMs$end_sbj, sep = "_")
  
  n_muts_enh <- enh_SSMs %>% group_by(name) %>% 
  dplyr::summarise(n_muts = n()) %>%
  ungroup() %>%
  dplyr::select(name, n_muts) 
  n_muts_enh <- arrange(n_muts_enh, desc(n_muts_enh$n_muts))
  
  p <- n_muts_enh %>%
  ggplot(., aes(x = n_muts))+
  geom_histogram()+
    theme_light()+
    labs(title = paste("Number of mutations within each ", marker, " enhancer", sep =""), 
         x = "Number of mutations", y = "")
  print(p)
 
  
  # Dotplot
  for_dot <- left_join(stat_enh, n_muts_enh, by = "name")
  for_dot$n_muts[is.na(for_dot$n_muts)] <- 0
  
    scatter <- for_dot %>% 
      ggplot(., aes(x = n_donors_hit, y = n_muts))+
        geom_count(aes(size = ..n..), color = "blue3")+
        scale_size_continuous(range = c(2, 10))+
        #geom_jitter(width=1, height=1)+
        theme_light()+
        labs(title = paste(marker, " enhancers - Win = ", WIN, " bp", sep = ""),
          y = "Number of mutations within enhancer", 
          x = "Number of donors")+
        theme(axis.text = element_text(size = 12),
              axis.title = element_text(size = 16),
              title = element_text(size = 16))+
        scale_y_continuous(n.breaks = 7)+
        scale_x_continuous(n.breaks = 8)
    print(scatter)
  
}

```


### Number of mutations x enhancers ###
Boxplots with controls (CtIP-high, CtIP-low, random seqs)
```{r}
# Option 2: High = primi 3; Low = ultimi 4
clust_high_ctip <- c("CtIP_cluster_2_Enh", "CtIP_cluster_3_Enh", "CtIP_cluster_5_Enh")
clust_high_grhl <- c("GRHL_cluster_1_Enh", "GRHL_cluster_2_Enh", "GRHL_cluster_4_Enh")
clust_low_ctip <- c("CtIP_cluster_6.2_Enh", "CtIP_cluster_6.3_Enh", "CtIP_cluster_6.1_Enh", "CtIP_cluster_6.0")
clust_low_grhl <- c("GRHL_cluster_5.2_Enh", "GRHL_cluster_5.3_Enh", "GRHL_cluster_5.1_Enh", "GRHL_cluster_5.0")

clust_high <- list("CtIP" = clust_high_ctip, "GRHL" = clust_high_grhl)
clust_low <- list("CtIP" = clust_low_ctip, "GRHL" = clust_low_grhl)
clust_all <- list("high" = clust_high, "low" = clust_low)
```

```{r}
input_variants <- STSMs
input_variants_gr <- STSMs_gr
  
sample_enhancers <- TRUE # If TRUE, sample 'n_enhancers_to_sample' from each cluster (high vs. low)
n_enhancers_to_sample <- 1500

plot_p_values_cases <- TRUE
sample_size <- 1900 # number of enhancers to sample with replacement
n_samples <- 1000
start_seed <- 4321

max_dim <- max(sapply(enh_all, function(df) dim(df)[1]))
number_mutations_x_enhancer <- list("CtIP" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)), 
                                    "GRHL" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)))

for(marker in MARKERS){
  mut <- "STSMs"
  
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'

  for(cluster in c("high", "low")){
    marker_enh_clust <- marker_enh[marker_enh$cluster %in% clust_all[[cluster]][[marker]], ]
    if(sample_enhancers == T){
      marker_enh_clust <- marker_enh_clust[sample(x = 1:dim(marker_enh_clust)[1], 
                                           size = n_enhancers_to_sample, replace = F),]
    }
    
    ## Extend regions of 'win' from summit
    marker_enh_clust$start <- marker_enh_clust$summit - WIN
    marker_enh_clust$end <- marker_enh_clust$summit + WIN
    
    # Generate random input sequences 
    ran_seqs <- generate_random_seqs(SEED, dim(marker_enh_clust)[1], win = WIN)
    # Create GRanges objects 
    enh_gr <- makeGRangesFromDataFrame(marker_enh_clust, keep.extra.columns = T)
    ran_seqs_gr = makeGRangesFromDataFrame(ran_seqs, keep.extra.columns = T)
    
    
    ### Find mutations / enhancers overlaps ###
    # CtIP/GRHL enhancers - overlap with matching SSMs 
    hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj) 
    # Random sequences
    hits_obj_ran <- findOverlaps(query=ran_seqs_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_ran)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    ran_seqs_SSMs <- cbind(data.frame(ran_seqs_gr[queryHits(hits_obj_ran)], SSMs_sbj))
    
    # Total number of enhancers mutated x group (high-low)
    print(sprintf("Total number of enhancers mutated x group - WIN: %d - Marker: %s", WIN, marker))
    print(paste(cluster, length(unique(enh_SSMs$name))))
  
    # Number of mutations within each enahncer
    n_muts_enh <- enh_SSMs %>% group_by(name) %>% 
      dplyr::summarise(n_muts = n()) %>%
      ungroup() %>%
      dplyr::select(name, n_muts) 

    n_muts_ran <- ran_seqs_SSMs %>% group_by(name) %>% 
      dplyr::summarise(n_muts = n()) %>%
      ungroup() %>%
      dplyr::select(name, n_muts) 
    n_muts_ran <- arrange(n_muts_ran, desc(n_muts_ran$n_muts))
    
    # Add enhancers with 0 mutations
    enh_0_muts <- unique(marker_enh_clust$name[!marker_enh_clust$name %in% n_muts_enh$name])
    n_muts_enh <- rbind(n_muts_enh, data.frame("name" = enh_0_muts, "n_muts" = 0))
    n_muts_enh <- arrange(n_muts_enh, desc(n_muts_enh$n_muts))
    
    # Add enhancers with 0 mutations
    ran_0_muts <- unique(ran_seqs$name[!ran_seqs$name %in% n_muts_ran$name])
    n_muts_ran <- rbind(n_muts_ran, data.frame("name" = ran_0_muts, "n_muts" = 0))
    n_muts_ran <- arrange(n_muts_ran, desc(n_muts_ran$n_muts))
    
    number_mutations_x_enhancer[[marker]][, cluster] <- c(n_muts_enh$n_muts, rep(NA, max_dim-length(n_muts_enh$n_muts)))
    number_mutations_x_enhancer[[marker]][, paste(cluster, "ctrl", sep="_")] <- c(n_muts_ran$n_muts, 
                                                                                  rep(NA, max_dim-length(n_muts_ran$n_muts)))
    
  }
}



## Plot mutation frequency x enhancer + CTRLs ##
for(marker in MARKERS){
  df <- number_mutations_x_enhancer[[marker]] 
  df_pivot <- df %>% pivot_longer(everything(), names_to="cluster", values_to="n_muts") %>%
  mutate(., group = ifelse(startsWith(cluster,"high"), "high", "low"))
  
  print("Average")
  m_high <- round(mean(df$high, na.rm =T),3)
  m_high_ctrl <- round(mean(df$high_ctrl, na.rm=T),3)
  m_low <- round(mean(df$low, na.rm=T),3)
  m_low_ctrl <- round(mean(df$low_ctrl, na.rm =T),3)
  print(m_high); print(m_high_ctrl); print(m_low); print(m_low_ctrl)
  
  p <- df_pivot %>% ggplot(., aes(x = cluster, y = n_muts, fill = group))+
    geom_boxplot()+
    theme_light()+
    labs(title = paste("Number of mutations x enhancer - ", marker, sep=""),
        y = "Number of mutations", x = "")+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p)
  
  p2 <- df_pivot %>% ggplot(., aes(x = cluster, y = n_muts, fill = group))+
    geom_violin()+
    theme_light()+
    labs(title = paste("Number of mutations x enhancer - ", marker, sep=""),
        y = "Number of mutations", x = "")+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p2)
}



### P-values distribution
if(plot_p_values_cases == T){
  pval_dist_cases <- compute_pval_dist_cases(n_samples = n_samples, start_seed = start_seed, 
                                             sample_size = sample_size, df_vars = number_mutations_x_enhancer)
}

for(marker in MARKERS){
  r_m <- round(sum(pval_dist_cases[[marker]] <= 0.05) / length(pval_dist_cases[[marker]]),2)

  p <- data.frame(x = pval_dist_cases[[marker]]) %>%
    ggplot(., aes(x))+
    geom_histogram()+
    geom_vline(xintercept = 0.05, color = "red")+
    labs(title = sprintf("Ratio of significant p-values: %.2f", r_m))
  print(p)
}

```



### Number of donors mutated x enhancers ###
Boxplots with controls (CtIP-high, CtIP-low, random seqs)
```{r}
input_variants <- STSMs
input_variants_gr <- STSMs_gr

  

max_dim <- max(sapply(enh_all, function(df) dim(df)[1]))
number_donors_x_enhancer <- list("CtIP" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)), 
                                    "GRHL" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)))


for(marker in MARKERS){
  mut <- "STSMs"
  
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'

  for(cluster in c("high", "low")){
    marker_enh_clust <- marker_enh[marker_enh$cluster %in% clust_all[[cluster]][[marker]], ]
    if(sample_enhancers == T){
      marker_enh_clust <- marker_enh_clust[sample(x = 1:dim(marker_enh_clust)[1], 
                                           size = n_enhancers_to_sample, replace = F),]
    }
    
    ## Extend regions of 'win' from summit
    marker_enh_clust$start <- marker_enh_clust$summit - WIN
    marker_enh_clust$end <- marker_enh_clust$summit + WIN
    
    # Generate random input sequences 
    ran_seqs <- generate_random_seqs(SEED, dim(marker_enh_clust)[1], win = WIN)
    # Create GRanges objects 
    enh_gr <- makeGRangesFromDataFrame(marker_enh_clust, keep.extra.columns = T)
    ran_seqs_gr = makeGRangesFromDataFrame(ran_seqs, keep.extra.columns = T)
    
    
    ### Find mutations / enhancers overlaps ###
    # CtIP/GRHL enhancers - overlap with matching SSMs 
    hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj) 
    # Random sequences
    hits_obj_ran <- findOverlaps(query=ran_seqs_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_ran)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    ran_seqs_SSMs <- cbind(data.frame(ran_seqs_gr[queryHits(hits_obj_ran)], SSMs_sbj))
  

    # Number of donors mutated x enhancer
    n_don_enh <- enh_SSMs %>% dplyr::group_by(name) %>%
      dplyr::summarise(., n_donors_hit = length(unique(icgc_donor_id)))
    n_don_ran <- ran_seqs_SSMs %>% dplyr::group_by(name) %>%
      dplyr::summarise(., n_donors_hit = length(unique(icgc_donor_id)))
    
    # Add enhancers mutated in 0 donors 
    enh_0_don <- unique(marker_enh_clust$name[!marker_enh_clust$name %in% n_don_enh$name])
    n_don_enh <- rbind(n_don_enh, data.frame("name" = enh_0_don, "n_donors_hit" = 0))
    ran_0_don <- unique(ran_seqs$name[!ran_seqs$name %in% n_don_ran$name])
    n_don_ran <- rbind(n_don_ran, data.frame("name" = ran_0_don, "n_donors_hit" = 0))
    
    ##REMOVE##
    number_donors_x_enhancer[[marker]][, cluster] <- c(n_don_enh$n_donors_hit, 
                                                       rep(NA, max_dim-length(n_don_enh$n_donors_hit)))
    number_donors_x_enhancer[[marker]][, paste(cluster, "ctrl", sep="_")] <- c(n_don_ran$n_donors_hit, 
                                                                            rep(NA, max_dim-length(n_don_ran$n_donors_hit)))
    
  }
}



## Plot mutation frequency x enhancer + CTRLs ##
for(marker in MARKERS){
  df <- number_donors_x_enhancer[[marker]] 
  df_pivot <- df %>% pivot_longer(everything(), names_to="cluster", values_to="n") %>%
  mutate(., group = ifelse(startsWith(cluster,"high"), "high", "low"))
  
  
  p <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_boxplot()+
    theme_light()+
    labs(title = paste("Number of donors mutates x enhancer - ", marker, sep=""),
        y = "Number of donors", x = "")+
    scale_fill_manual(values = c("darkviolet", "darkolivegreen3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p)
  
  p2 <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_violin()+
    theme_light()+
    labs(title = paste("Number of donors mutates x enhancer - ", marker, sep=""),
        y = "Number of donors", x = "")+
    scale_fill_manual(values = c("darkviolet", "darkolivegreen3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p2)
}

```




### Number of enhancers mutated x donor ###
Boxplots with controls (CtIP-high, CtIP-low, random seqs)
```{r}
input_variants <- STSMs
input_variants_gr <- STSMs_gr


max_dim <- max(sapply(enh_all, function(df) dim(df)[1]))
number_enhancers_x_donor <- list("CtIP" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)), 
                                    "GRHL" = data.frame("high" = rep(NA, max_dim), "high_ctrl" = rep(NA, max_dim), 
                                                        "low" = rep(NA, max_dim), "low_ctrl" = rep(NA, max_dim)))

for(marker in MARKERS){
  mut <- "STSMs"
  
  # CtIP/GRHL enhancers
  marker_enh <- enh_all[[marker]] # select enhancer with 'marker'

  for(cluster in c("high", "low")){
    marker_enh_clust <- marker_enh[marker_enh$cluster %in% clust_all[[cluster]][[marker]], ]
    if(sample_enhancers == T){
      marker_enh_clust <- marker_enh_clust[sample(x = 1:dim(marker_enh_clust)[1], 
                                           size = n_enhancers_to_sample, replace = F),]
    }
    
    ## Extend regions of 'win' from summit
    marker_enh_clust$start <- marker_enh_clust$summit - WIN
    marker_enh_clust$end <- marker_enh_clust$summit + WIN
    
    # Generate random input sequences 
    ran_seqs <- generate_random_seqs(SEED, dim(marker_enh_clust)[1], win = WIN)
    # Create GRanges objects 
    enh_gr <- makeGRangesFromDataFrame(marker_enh_clust, keep.extra.columns = T)
    ran_seqs_gr = makeGRangesFromDataFrame(ran_seqs, keep.extra.columns = T)
    
    
    ### Find mutations / enhancers overlaps ###
    # CtIP/GRHL enhancers - overlap with matching SSMs 
    hits_obj_enh <- findOverlaps(query=enh_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_enh)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    enh_SSMs <- cbind(data.frame(enh_gr[queryHits(hits_obj_enh)]), SSMs_sbj) 
    # Random sequences
    hits_obj_ran <- findOverlaps(query=ran_seqs_gr, subject=input_variants_gr)
    SSMs_sbj <- data.frame(input_variants_gr[subjectHits(hits_obj_ran)])
    colnames(SSMs_sbj)[1:5] <- paste(colnames(SSMs_sbj)[1:5], "sbj", sep = "_")
    ran_seqs_SSMs <- cbind(data.frame(ran_seqs_gr[queryHits(hits_obj_ran)], SSMs_sbj))
  

    # Number of donors mutated x enhancer
    n_enh_mut <- enh_SSMs %>% dplyr::group_by(icgc_donor_id) %>%
      dplyr::summarise(., n_enh_hit = length(unique(name)))
    n_ran_mut <- ran_seqs_SSMs %>% dplyr::group_by(icgc_donor_id) %>%
      dplyr::summarise(., n_ran_hit = length(unique(name)))
    
    # Add donors with 0 enhancers mutated
    don_0_enh <- unique(SSMs$icgc_donor_id[!SSMs$icgc_donor_id %in% n_enh_mut$icgc_donor_id])
    n_enh_mut <- rbind(n_enh_mut, data.frame("icgc_donor_id" = don_0_enh, "n_enh_hit" = 0))
    don_0_ran <- unique(SSMs$icgc_donor_id[!SSMs$icgc_donor_id %in% n_ran_mut$icgc_donor_id])
    n_ran_mut <- rbind(n_ran_mut, data.frame("icgc_donor_id" = don_0_ran, "n_ran_hit" = 0))
    
    
    ##REMOVE##
    number_enhancers_x_donor[[marker]][, cluster] <- c(n_enh_mut$n_enh_hit, 
                                                       rep(NA, max_dim-length(n_enh_mut$n_enh_hit)))
    number_enhancers_x_donor[[marker]][, paste(cluster, "ctrl", sep="_")] <- c(n_ran_mut$n_ran_hit, 
                                                                            rep(NA, max_dim-length(n_ran_mut$n_ran_hit)))
    
  }
}



## Plot mutation frequency x enhancer + CTRLs ##
for(marker in MARKERS){
  df <- number_enhancers_x_donor[[marker]] 
  df_pivot <- df %>% pivot_longer(everything(), names_to="cluster", values_to="n") %>%
  mutate(., group = ifelse(startsWith(cluster,"high"), "high", "low"))
  
  p <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_boxplot()+
    theme_light()+
    labs(title = paste("Number of enhancers mutated x donor - ", marker, sep=""),
        y = "Number of enhancers", x = "")+
    scale_fill_manual(values = c("brown3", "deepskyblue3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p)
  
  p2 <- df_pivot %>% ggplot(., aes(x = cluster, y = n, fill = group))+
    geom_violin()+
    theme_light()+
    labs(title = paste("Number of enhancers mutated x donor - ", marker, sep=""),
        y = "Number of enhancers", x = "")+
    scale_fill_manual(values = c("brown3", "deepskyblue3"))+
    stat_compare_means(method = "wilcox.test", 
                       label = "p.format", 
                       size = 3, 
                       comparisons = list(c("high", "high_ctrl"), c("low", "low_ctrl"), c("high", "low")))
  print(p2)
}

```



